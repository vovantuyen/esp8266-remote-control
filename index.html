<!DOCTYPE html>
<html>
<head>
    <title>Điều khiển ESP8266</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 400px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; }
        button {
            display: block;
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            font-size: 18px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #45a049; }
        .status-section { margin-top: 20px; padding: 15px; background-color: #e9e9e9; border-radius: 5px; }
        .status-item { margin-bottom: 10px; font-size: 16px; }
        .status-label { font-weight: bold; }
        .status-value { float: right; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>Điều khiển thiết bị</h2>

        <button onclick="publishCommand('out1', true)">BẬT Thiết bị 1</button>
        <button onclick="publishCommand('out1', false)">TẮT Thiết bị 1</button>
        <hr>
        <button onclick="publishCommand('out2', true)">BẬT Thiết bị 2</button>
        <button onclick="publishCommand('out2', false)">TẮT Thiết bị 2</button>

        <div class="status-section">
            <h3>Trạng thái & Dữ liệu</h3>
            <div class="status-item">
                <span class="status-label">Nhiệt độ:</span> <span id="temperature" class="status-value">-- °C</span>
            </div>
            <div class="status-item">
                <span class="status-label">Độ ẩm:</span> <span id="humidity" class="status-value">-- %</span>
            </div>
            <div class="status-item">
                <span class="status-label">Thiết bị 1:</span> <span id="out1_status" class="status-value">Tắt</span>
            </div>
            <div class="status-item">
                <span class="status-label">Thiết bị 2:</span> <span id="out2_status" class="status-value">Tắt</span>
            </div>
            <p style="font-size: 12px; text-align: center;">Trạng thái kết nối: <span id="connection_status">Đang kết nối...</span></p>
        </div>
    </div>

    <script>
        // Cấu hình MQTT Broker (thay thế bằng thông tin HiveMQ của bạn)
        const host = "e050d42a346b4aa783baad6c46147053.s1.eu.hivemq.cloud"; // Host của bạn
        const port = 8883; // Port SSL/TLS
        const username = "vvt1998"; // Username của bạn
        const password = "12345Aa@"; // Password của bạn
        const clientID = "web_client_" + parseInt(Math.random() * 100); // Client ID ngẫu nhiên

        let client;

        // Khởi tạo và kết nối tới MQTT Broker
        function connectMQTT() {
            client = new Paho.MQTT.Client(host, port, clientID);

            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            const connectOptions = {
                userName: username,
                password: password,
                useSSL: true, // Quan trọng: Sử dụng SSL/TLS
                onSuccess: onConnect,
                onFailure: onFailure
            };

            client.connect(connectOptions);
            document.getElementById('connection_status').innerText = 'Đang kết nối...';
        }

        function onConnect() {
            console.log("Đã kết nối MQTT Broker.");
            document.getElementById('connection_status').innerText = 'Đã kết nối';
            // Đăng ký các topic để nhận dữ liệu từ ESP8266
            client.subscribe("esp8266/dht11", { qos: 0 });
            client.subscribe("esp8266/out", { qos: 0 });
            console.log("Đã đăng ký các topic: esp8266/dht11, esp8266/out");
        }

        function onFailure(responseObject) {
            console.log("Kết nối thất bại: " + responseObject.errorMessage);
            document.getElementById('connection_status').innerText = 'Mất kết nối! Đang thử lại...';
            setTimeout(connectMQTT, 5000); // Thử kết nối lại sau 5 giây
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Mất kết nối: " + responseObject.errorMessage);
                document.getElementById('connection_status').innerText = 'Mất kết nối! Đang thử lại...';
                setTimeout(connectMQTT, 5000); // Thử kết nối lại sau 5 giây
            }
        }

        function onMessageArrived(message) {
            console.log("Tin nhắn đến từ [" + message.destinationName + "]: " + message.payloadString);
            try {
                const data = JSON.parse(message.payloadString);
                if (message.destinationName === "esp8266/dht11") {
                    document.getElementById('temperature').innerText = (data.temperature ? data.temperature.toFixed(1) : '--') + " °C";
                    document.getElementById('humidity').innerText = (data.humidity ? data.humidity.toFixed(1) : '--') + " %";
                } else if (message.destinationName === "esp8266/out") {
                    document.getElementById('out1_status').innerText = data.out1 ? 'Bật' : 'Tắt';
                    document.getElementById('out2_status').innerText = data.out2 ? 'Bật' : 'Tắt';
                }
            } catch (e) {
                console.error("Lỗi parse JSON:", e);
            }
        }

        // Gửi lệnh điều khiển tới ESP8266
        function publishCommand(outputKey, state) {
            const topic = "esp8266/client";
            const payload = JSON.stringify({ [outputKey]: state }); // Tạo JSON payload động
            const message = new Paho.MQTT.Message(payload);
            message.destinationName = topic;
            message.retained = true; // Giữ lại trạng thái trên broker
            client.send(message);
            console.log("Đã gửi lệnh [" + topic + "]: " + payload);
        }

        // Bắt đầu kết nối khi trang tải xong
        window.onload = connectMQTT;
    </script>
</body>
</html>